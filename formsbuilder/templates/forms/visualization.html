<div class="space-y-6">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <h1 class="text-3xl font-bold text-gray-900">{{ department.name }} - Data Visualization</h1>
        
      
        <!-- Filter -->
        
    </div>
      

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Total Enquiries Card -->
        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-medium text-gray-500">Total Enquiries</h3>
                <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                    <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
                    </svg>
                </div>
            </div>
            <div class="flex items-end justify-between">
                <div>
                    <div class="text-2xl font-bold text-gray-900">{{ total_count }}</div>
                </div>
            </div>
        </div>

        <!-- Pending Card (was In Progress) -->
        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-medium text-gray-500">Pending</h3>
                <div class="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center">
                    <svg class="w-4 h-4 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 2a8 8 0 100 16 8 8 0 000-16zm3.54 11.4l-4.95-2.89V6h1.5v3.7l4.05 2.36-1.6 1.34z"/>
                    </svg>
                </div>
            </div>
            <div class="flex items-end justify-between">
                <div>
                    <div class="text-2xl font-bold text-gray-900">{{ pending_count }}</div>
                </div>
            </div>
        </div>

        <!-- Resolved Card -->
        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-medium text-gray-500">Resolved</h3>
                <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                    <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                </div>
            </div>
            <div class="flex items-end justify-between">
                <div>
                    <div class="text-2xl font-bold text-gray-900">{{ resolved_count }}</div>
                </div>
            </div>
        </div>
    </div>

    <select name="viz_filter" 
                class="w-full md:w-auto px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors duration-200"
                hx-get="{% url 'dashboard' %}"
                hx-target="#content-area"
                hx-swap="innerHTML"
                hx-trigger="change"
                hx-params="section=visualization,viz_filter">
            <option value="all" {% if viz_filter == 'all' %}selected{% endif %}>All Time</option>
            <option value="day" {% if viz_filter == 'day' %}selected{% endif %}>Last 7 Days</option>
            <option value="month" {% if viz_filter == 'month' %}selected{% endif %}>This Month</option>
            <option value="year" {% if viz_filter == 'year' %}selected{% endif %}>This Year</option>
        </select>

    <!-- Charts -->
    <div class="space-y-6">
        <!-- Line Chart - Full Width -->
        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
            <div class="mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Enquiries Over Time</h3>
            </div>
            <div class="h-96">
                <canvas id="lineChart" class="w-full h-full"></canvas>
            </div>
        </div>

        <!-- Doughnut and Pie Charts - Split -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Status Distribution</h3>
                </div>
                <div class="h-80">
                    <canvas id="doughnutChart" class="w-full h-full"></canvas>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Enquiries by Form Type</h3>
                </div>
                <div class="h-80">
                    <canvas id="pieChart" class="w-full h-full"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    function initializeCharts() {
        // Destroy existing charts to prevent duplicates
        if (window.lineChart && window.lineChart instanceof Chart) window.lineChart.destroy();
        if (window.doughnutChart && window.doughnutChart instanceof Chart) window.doughnutChart.destroy();
        if (window.pieChart && window.pieChart instanceof Chart) window.pieChart.destroy();

        // Get chart data and filter
        const chartData = {{ chart_data|safe }};
        const doughnutData = {{ doughnut_data|safe }};
        const pieData = {{ pie_data|safe }};
        const vizFilter = '{{ viz_filter }}';
        console.log('Current viz_filter:', vizFilter);
        console.log('Chart Data:', chartData);
        console.log('Doughnut Data:', doughnutData);
        console.log('Pie Data:', pieData);
        console.log('Initializing charts at:', new Date().toISOString());

        // Validate data
        if (!chartData || !chartData.labels || !chartData.counts || chartData.labels.length === 0 || chartData.counts.length === 0) {
            console.error('Invalid line chart data:', chartData);
            return;
        }
        if (!doughnutData || !doughnutData.labels || !doughnutData.counts || doughnutData.labels.length === 0 || doughnutData.counts.length === 0) {
            console.error('Invalid doughnut chart data:', doughnutData);
            return;
        }
        if (!pieData || !pieData.labels || !pieData.counts || pieData.labels.length === 0 || pieData.counts.length === 0) {
            console.error('Invalid pie chart data:', pieData);
            return;
        }

        // Ensure canvas elements exist
        const lineCanvas = document.getElementById('lineChart');
        const doughnutCanvas = document.getElementById('doughnutChart');
        const pieCanvas = document.getElementById('pieChart');
        if (!lineCanvas || !doughnutCanvas || !pieCanvas) {
            console.error('Canvas elements not found:', { lineCanvas, doughnutCanvas, pieCanvas });
            return;
        }

        // Dynamic X-axis formatting based on viz_filter
        const xAxisOptions = {
            grid: { display: false },
            ticks: { 
                color: '#6B7280',
                maxTicksLimit: vizFilter === 'month' ? 10 : 12,
                callback: function(value, index, values) {
                    const label = this.getLabelForValue(value);
                    try {
                        if (vizFilter === 'day') {
                            const date = new Date(label);
                            return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                        } else if (vizFilter === 'month') {
                            const date = new Date(label);
                            return date.toLocaleDateString('en-US', { day: 'numeric' });
                        } else if (vizFilter === 'year') {
                            return label; // Already formatted as %b
                        } else {
                            return label; // Year-month format
                        }
                    } catch (e) {
                        console.error('Error formatting label:', label, e);
                        return label;
                    }
                }
            },
            title: {
                display: true,
                text: vizFilter === 'day' ? 'Date' : vizFilter === 'month' ? 'Day of Month' : vizFilter === 'year' ? 'Month' : 'Year-Month',
                color: '#374151',
                font: { size: 14 }
            }
        };

        // Initialize line chart
        try {
            window.lineChart = new Chart(lineCanvas, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Enquiries',
                        data: chartData.counts,
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#3B82F6',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false }, 
                        title: { 
                            display: true,
                            text: 'Enquiries Over Time (' + (vizFilter === 'day' ? 'Last 7 Days' : vizFilter === 'month' ? 'This Month' : vizFilter === 'year' ? 'This Year' : 'All Time') + ')',
                            color: '#374151',
                            font: { size: 16 }
                        }
                    },
                    scales: { 
                        x: xAxisOptions, 
                        y: { 
                            grid: { color: '#F3F4F6' },
                            ticks: { color: '#6B7280' },
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Enquiries',
                                color: '#374151',
                                font: { size: 14 }
                            }
                        } 
                    },
                    elements: {
                        point: { hoverBackgroundColor: '#3B82F6' }
                    }
                }
            });

            window.doughnutChart = new Chart(doughnutCanvas, {
                type: 'doughnut',
                data: {
                    labels: doughnutData.labels,
                    datasets: [{
                        data: doughnutData.counts,
                        backgroundColor: ['#FCD34D', '#06B6D4', '#10B981', '#EF4444'],
                        borderWidth: 0,
                        hoverBorderWidth: 2,
                        hoverBorderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: { 
                        legend: { 
                            display: true, 
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                color: '#374151'
                            }
                        }, 
                        title: { display: false }
                    }
                }
            });

            window.pieChart = new Chart(pieCanvas, {
                type: 'pie',
                data: {
                    labels: pieData.labels,
                    datasets: [{
                        data: pieData.counts,
                        backgroundColor: ['#3B82F6', '#8B5CF6', '#F59E0B', '#10B981', '#EF4444'],
                        borderWidth: 0,
                        hoverBorderWidth: 2,
                        hoverBorderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            display: true, 
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                color: '#374151'
                            }
                        }, 
                        title: { display: false }
                    }
                }
            });
            console.log('Charts initialized successfully');
        } catch (error) {
            console.error('Error initializing charts:', error);
        }
    }

    initializeCharts();
})();
</script>